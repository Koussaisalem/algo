name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Run full test suite
      run: |
        pip install pytest pytest-cov
        pytest core/qcmd_ecs/tests/ -v --cov=core/qcmd_ecs/core

    - name: Create release archive
      run: |
        # Create distribution package
        mkdir -p dist
        
        # Core framework
        tar -czf dist/qcmd-ecs-core.tar.gz \
          core/qcmd_ecs/ \
          core/models/ \
          requirements.txt \
          README.md \
          LICENSE
        
        # Discovery tools
        tar -czf dist/phononic-discovery-tools.tar.gz \
          projects/phononic-discovery/framework/scripts/ \
          projects/phononic-discovery/framework/manifold_utils.py \
          projects/phononic-discovery/README.md
        
        # Documentation
        tar -czf dist/documentation.tar.gz \
          docs/ \
          README.md
        
        echo "âœ… Release archives created"

    - name: Generate release notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # Release Notes
        
        ## Quantum Materials Discovery Platform
        
        ### Core Components
        - âœ… Stiefel manifold diffusion framework
        - âœ… Multi-scale validation pipeline (xTB â†’ DFT)
        - âœ… GNN-based surrogate models
        - âœ… Score-based generative models
        
        ### Validated Discoveries
        - ðŸ”¬ CrCuSeâ‚‚ (hetero-metallic TMD, 0.616 eV bandgap)
        
        ### Installation
        ```bash
        pip install -r requirements.txt
        pytest core/qcmd_ecs/tests/  # Verify installation
        ```
        
        ### Quick Start
        See [README.md](README.md) for full documentation.
        
        ### Citation
        If you use this platform in your research, please cite:
        - Repository: https://github.com/${{ github.repository }}
        - Discovery: CrCuSeâ‚‚ first hetero-metallic TMD
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        body_path: RELEASE_NOTES.md
        files: |
          dist/*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-build:
    runs-on: ubuntu-latest
    needs: create-release
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM python:3.10-slim
        
        WORKDIR /app
        
        # Install system dependencies
        RUN apt-get update && apt-get install -y \
            libopenblas-dev \
            git \
            && rm -rf /var/lib/apt/lists/*
        
        # Copy requirements and install Python dependencies
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        
        # Copy source code
        COPY core/ ./core/
        COPY projects/ ./projects/
        COPY docs/ ./docs/
        COPY README.md .
        
        # Set up entry point
        CMD ["python", "-c", "from core.qcmd_ecs.core import manifold; print('QCMD-ECS Platform Ready')"]
        EOF

    - name: Build Docker image
      run: |
        docker build -t qcmd-ecs:${{ github.ref_name }} .
        echo "âœ… Docker image built successfully"
