name: Weekly Benchmarks

on:
  schedule:
    # Run every Monday at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  manifold-accuracy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install tabulate

    - name: Run manifold precision benchmarks
      run: |
        python -c "
        import torch
        import time
        from core.qcmd_ecs.core.manifold import project_to_tangent_space, retract_to_manifold
        from core.qcmd_ecs.core.types import DTYPE
        
        print('=' * 60)
        print('MANIFOLD OPERATION BENCHMARKS')
        print('=' * 60)
        
        sizes = [(16, 4), (32, 8), (64, 16), (128, 32)]
        
        for m, k in sizes:
            U = torch.randn(m, k, dtype=DTYPE)
            U, _ = torch.linalg.qr(U)
            gradient = torch.randn(m, k, dtype=DTYPE)
            
            # Benchmark projection
            start = time.time()
            for _ in range(100):
                U_tangent = project_to_tangent_space(U, gradient)
            proj_time = (time.time() - start) / 100
            
            # Benchmark retraction
            start = time.time()
            for _ in range(100):
                U_new = retract_to_manifold(U + 0.01 * U_tangent)
            retract_time = (time.time() - start) / 100
            
            # Check accuracy
            eye_k = torch.eye(k, dtype=DTYPE)
            orthog_error = torch.norm(U_new.T @ U_new - eye_k).item()
            
            print(f'\nSize ({m}, {k}):')
            print(f'  Projection: {proj_time*1000:.3f} ms')
            print(f'  Retraction: {retract_time*1000:.3f} ms')
            print(f'  Orthogonality error: {orthog_error:.2e}')
            
            assert orthog_error < 1e-9, f'Orthogonality violated: {orthog_error}'
        
        print('\n✅ All benchmarks passed')
        print('=' * 60)
        "

    - name: Run diffusion convergence test
      run: |
        python -c "
        import torch
        import numpy as np
        from core.qcmd_ecs.core.dynamics import run_reverse_diffusion
        from core.qcmd_ecs.core.types import DTYPE
        
        print('\n' + '=' * 60)
        print('DIFFUSION CONVERGENCE TEST')
        print('=' * 60)
        
        torch.manual_seed(42)
        m, k = 32, 8
        
        # Simple energy landscape with known minimum
        target = torch.randn(m, k, dtype=DTYPE)
        target, _ = torch.linalg.qr(target)
        
        def energy_fn(U):
            # Negative trace(U^T target) - should maximize alignment
            return -torch.einsum('mk,mk->m', U, target.unsqueeze(0).expand(U.shape[0], -1, -1)).squeeze()
        
        def score_fn(U):
            # Gradient of energy
            return target.unsqueeze(0).expand(U.shape[0], -1, -1)
        
        U_init = torch.randn(m, k, dtype=DTYPE)
        U_init, _ = torch.linalg.qr(U_init)
        
        results = run_reverse_diffusion(
            score_fn=score_fn,
            energy_fn=energy_fn,
            U_T=U_init,
            num_steps=100,
            dt=1e-3
        )
        
        U_final = results['samples'][-1]
        
        # Check convergence
        initial_energy = energy_fn(U_init.unsqueeze(0)).item()
        final_energy = energy_fn(U_final.unsqueeze(0)).item()
        
        print(f'\nInitial energy: {initial_energy:.4f}')
        print(f'Final energy: {final_energy:.4f}')
        print(f'Energy improvement: {final_energy - initial_energy:.4f}')
        
        assert final_energy > initial_energy, 'Energy did not improve'
        print('\n✅ Diffusion converged correctly')
        print('=' * 60)
        "

  model-import-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify all model architectures load
      run: |
        python -c "
        print('Testing model imports...')
        
        try:
            from core.models.score_model import ScoreModel
            print('✓ ScoreModel')
        except Exception as e:
            print(f'✗ ScoreModel: {e}')
        
        try:
            from core.models.surrogate import Surrogate
            print('✓ Surrogate')
        except Exception as e:
            print(f'✗ Surrogate: {e}')
        
        try:
            from core.models.tmd_surrogate import TMDSurrogate
            print('✓ TMDSurrogate')
        except Exception as e:
            print(f'✗ TMDSurrogate: {e}')
        
        try:
            from core.models.simple_score_model import SimpleScoreModel
            print('✓ SimpleScoreModel')
        except Exception as e:
            print(f'✗ SimpleScoreModel: {e}')
        
        print('\n✅ All model imports successful')
        "

  create-benchmark-report:
    runs-on: ubuntu-latest
    needs: [manifold-accuracy, model-import-check]
    if: always()
    
    steps:
    - name: Generate benchmark summary
      run: |
        echo "# Weekly Benchmark Report" > benchmark_report.md
        echo "" >> benchmark_report.md
        echo "**Date:** $(date)" >> benchmark_report.md
        echo "" >> benchmark_report.md
        echo "## Results" >> benchmark_report.md
        echo "" >> benchmark_report.md
        echo "- Manifold Accuracy: ${{ needs.manifold-accuracy.result }}" >> benchmark_report.md
        echo "- Model Import Check: ${{ needs.model-import-check.result }}" >> benchmark_report.md
        
    - name: Upload benchmark report
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-report
        path: benchmark_report.md
        retention-days: 90
